<?php
/**
 * @file
 * Code for the DoSomething Campaign Group feature.
 */

include_once 'dosomething_campaign_group.features.inc';


function dosomething_campaign_group_preprocess_node(&$vars) {
  if ($vars['type'] == 'campaign_group') {
    $content = $vars['content'];
    $template_vars = array(
      'text' => array(
        'subtitle',
        'intro_title',
        'intro',
        'additional_text_title',
        'additional_text',
        'post_signup_title',
        'post_signup_body',
        'call_to_action',
      ),
      'link' => array(
        'cta_link'
      ),
    );

    foreach ($template_vars as $key => $labels) {
      foreach ($labels as $label) {
        $field = "field_{$label}";
          if (isset($content[$field])) {
          switch ($key) {
            case 'text':
              $vars[$label] = $content[$field][0]['#markup'];
              break;
            case 'link':
              $vars[$label] = l($content[$field][0]['#element']['title'], $content[$field][0]['#element']['url'], array('attributes' => array('class' => 'btn')));
            break;
            default:
              break;
          }
        }
      }
    }

    $wrapper = entity_metadata_wrapper('node', $vars['node']);
    if ($wrapper->field_video->value()->field_video_id) {
      $vars['intro_video'] = theme('dosomething_video_embed', array('field' => $wrapper->field_video->value()));
    }

    // Collect all field_collection values as vars.
    $field_collections = array('faq');
    foreach ($field_collections as $fc) {
      $vars[$fc] = dosomething_helpers_get_field_collection_values($wrapper, 'field_' . $fc);
    }

    if (!empty($vars['field_partners'])) {
      // Sets partners, sponsors, and partner_info arrays if present.
      dosomething_helpers_preprocess_partners_vars($vars);
      dosomething_helpers_format_partners_list($vars);
    }

    // Preprocess gallery variables.
    dosomething_static_content_preprocess_gallery_vars($vars);

    $vars['display_signup_form'] = $vars['field_display_signup_form'][0]['value'];
    if ($vars['display_signup_form']) {
      // Set default in case CTA label is not set.
      $label = NULL;
      if (isset($content['field_cta_link'][0]['#element']['title'])) {
        $label = $content['field_cta_link'][0]['#element']['title'];
      }
      dosomething_signup_preprocess_signup_button($vars, $label);
    }
  }
}

/**
 * Returns a Campaign Group parent nid for a given node $nid.
 *
 */
function dosomething_campaign_group_get_parent_nid($nid) {
  $result = db_select('field_data_field_campaigns', 'c')
    ->condition('field_campaigns_target_id', $nid)
    ->condition('deleted', 0)
    ->fields('c', array('entity_id'))
    ->execute();
  return $result->fetchField(0);
}
